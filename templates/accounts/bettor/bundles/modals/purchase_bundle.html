{% load widget_tweaks %}
<div class="modal fade" id="purchaseBundle{{ bundle.id }}" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form action="{% url 'bettor:bundles_all' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="bundle_id" value="{{ bundle.id }}">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-hand-holding-dollar me-1"></i> Buy Bundle - {{ bundle.name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <!-- Hidden fields for price, multipliers, and bundles per user -->
                        <input type="hidden" id="bundle-price-{{ bundle.id }}" value="{{ bundle.price }}">
                        <input type="hidden" id="min-multiplier-{{ bundle.id }}"
                            value="{{ bundle.minimum_win_multiplier }}">
                        <input type="hidden" id="max-multiplier-{{ bundle.id }}"
                            value="{{ bundle.maximum_win_multiplier }}">
                        <input type="hidden" id="min-bundles-{{ bundle.id }}" value="{{ bundle.min_bundles_per_user }}">
                        <input type="hidden" id="max-bundles-{{ bundle.id }}" value="{{ bundle.max_bundles_per_user }}">

                        <div class="mb-2 col-12">
                            <label for="quantity-{{ bundle.id }}">Quantity:</label>
                            <select name="quantity" id="quantity-{{ bundle.id }}" class="form-control"></select>
                        </div>
                        <!-- Display total amount and potential win -->
                        <div class="mb-2 col-md-6">
                            <label for="total-amount-display-{{ bundle.id }}">Total Amount:</label>
                            <span id="total-amount-display-{{ bundle.id }}"
                                class="fw-bold fs-5 d-block text-success"></span>
                        </div>
                        <div class="mb-2 col-md-6">
                            <label for="potential-win-display-{{ bundle.id }}">Potential Returns:</label>
                            <span id="potential-win-display-{{ bundle.id }}"
                                class="fw-bold fs-5 d-block text-primary"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">
                        <i class="fa-solid fa-times-circle me-2"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fa-solid fa-check-circle me-2"></i> Proceed
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('div[id^="purchaseBundle"]').forEach(function (modal) {
            const bundleId = modal.getAttribute('id').replace('purchaseBundle', '');

            const quantitySelect = document.getElementById(`quantity-${bundleId}`);
            const totalAmountDisplay = document.getElementById(`total-amount-display-${bundleId}`);
            const potentialWinDisplay = document.getElementById(`potential-win-display-${bundleId}`);

            // Get bundle price and win multipliers
            const bundlePrice = parseFloat(document.getElementById(`bundle-price-${bundleId}`).value);
            const minMultiplier = parseInt(document.getElementById(`min-multiplier-${bundleId}`).value);
            const maxMultiplier = parseInt(document.getElementById(`max-multiplier-${bundleId}`).value);

            // Get min and max bundles per user
            const minBundles = parseInt(document.getElementById(`min-bundles-${bundleId}`).value);
            const maxBundles = parseInt(document.getElementById(`max-bundles-${bundleId}`).value);

            // Clear the select field before populating it
            quantitySelect.innerHTML = '';  // This clears any previously added options

            // Add an empty option at the top to prevent pre-selection
            const defaultOption = document.createElement('option');
            defaultOption.value = ''; // No value means no option is selected by default
            defaultOption.textContent = 'Select Quantity';
            defaultOption.disabled = true;  // Disable this option so it's not selectable again
            defaultOption.selected = true;  // This ensures it's the initially selected option
            quantitySelect.appendChild(defaultOption);

            // Dynamically populate quantity select field with valid options
            for (let i = minBundles; i <= maxBundles; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                quantitySelect.appendChild(option);
            }

            // Update total amount and potential win on quantity change
            quantitySelect.addEventListener('change', function () {
                const quantity = parseInt(this.value) || 0;
                const totalAmount = bundlePrice * quantity;
                const potentialMinWin = totalAmount * minMultiplier; // Minimum potential win
                const potentialMaxWin = totalAmount * maxMultiplier; // Maximum potential win

                // Format the total amount and potential win range with currency and commas
                const formattedTotalAmount = `₦${totalAmount.toLocaleString('en-US')}`;
                const formattedPotentialWin = `₦${potentialMinWin.toLocaleString('en-US')} - ₦${potentialMaxWin.toLocaleString('en-US')}`;

                // Display the formatted values
                totalAmountDisplay.textContent = formattedTotalAmount;
                potentialWinDisplay.textContent = formattedPotentialWin;
            });

            // Clear form fields when modal is closed
            modal.addEventListener('hidden.bs.modal', function () {
                quantitySelect.value = '';  // Reset the select input
                totalAmountDisplay.textContent = '';  // Clear the total amount
                potentialWinDisplay.textContent = '';  // Clear the potential win display
            });
        });
    });
</script>